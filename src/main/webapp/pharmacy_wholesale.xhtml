<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:bil="http://java.sun.com/jsf/composite/bill"
      xmlns:phi="http://java.sun.com/jsf/composite/pharmacy"
      xmlns:pa="http://java.sun.com/jsf/composite/paymentMethod">
    <body>
        <ui:composition template="./resources/template/template.xhtml">
            <ui:define name="content">
                <h:form id="bill" >
                    <p:defaultCommand  target="btnAdd" />  

                    <p:panel rendered="#{!pharmacyWholesaleController.billPreview}"  header="Pharmacy Wholesale Bill" >
                        <h:panelGrid columns="12" >
                            <p:outputLabel value="Customer" ></p:outputLabel>
                            <p:autoComplete value="#{pharmacyWholesaleController.preBill.toInstitution}"
                                            completeMethod="#{institutionController.completeCreditCompany}"
                                            var="cu" placeholder="Select Customer" forceSelection="true"
                                            itemLabel="#{cu.name}" itemValue="#{cu}" ></p:autoComplete>
                            <p:spacer height="1" width="10"></p:spacer>
                            <h:outputLabel value="Payment" ></h:outputLabel>
                            <p:selectOneMenu   id="cmbPs" value="#{pharmacyWholesaleController.preBill.paymentMethod}">     
                                <f:selectItems value="#{enumController.paymentMethods}"/>
                                <p:ajax process="cmbPs" update="pBillDetails :#{p:component('tblBillItem')} :#{p:component('panelBillTotals')} :#{p:component('txtQty')} :#{p:component('txtRate')}" 
                                        event="change"   />

                            </p:selectOneMenu>
                            <p:commandButton ajax= "false" accesskey="s" value="Settle" 
                                             action="#{pharmacyWholesaleController.settleBillWithPay}" 
                                             update=" :#{p:component('panelErrorMessage')} :#{p:component('tblBillItem')} :#{p:component('txtRate')} :#{p:component('txtQty')} :#{p:component('acStock')}"  process="cmbPs" actionListener="#{pharmacyWholesaleController.calculateAllRates}">
                                <f:facet name="title" >
                                    <h:outputLabel value="S" style="text-decoration: underline;" ></h:outputLabel>
                                    <h:outputLabel value="ettle"  ></h:outputLabel>
                                </f:facet>
                            </p:commandButton>

                            <p:commandButton accesskey="n" value="New Bill"  ajax="false" action="#{pharmacyWholesaleController.newSaleBill}"  ></p:commandButton>
                            <h:panelGrid id="pBillDetails"  >

                                <h:panelGroup id="creditCardBill" style="display: #{pharmacyWholesaleController.preBill.paymentMethod ne 'Card' ? 'none' : 'block'} ; ">
                                    <pa:creditCard paymentMethodData="#{pharmacyWholesaleController.paymentMethodData}"/>
                                </h:panelGroup>

                                <h:panelGroup id="chequeBill" style="display: #{pharmacyWholesaleController.preBill.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; " >
                                    <pa:cheque paymentMethodData="#{pharmacyWholesaleController.paymentMethodData}"/>
                                </h:panelGroup>

                                <h:panelGroup id="slipBill" style="display: #{pharmacyWholesaleController.preBill.paymentMethod ne 'Slip' ? 'none' : 'block'} ;">
                                    <pa:slip paymentMethodData="#{pharmacyWholesaleController.paymentMethodData}"/>
                                </h:panelGroup>

                            </h:panelGrid>
                        </h:panelGrid>

                        <h:panelGroup rendered="#{pharmacyWholesaleController.errorMessage ne null}" id="panelErrorMessage" >
                            <p:outputLabel value="#{pharmacyWholesaleController.errorMessage}" style="color: red; padding: 2px; margin: 2px; border: 1px solid red;" ></p:outputLabel>
                        </h:panelGroup>

                        <p:panel >
                            <f:facet name="header" >
                                <p:outputLabel value="Add New Bill Item" ></p:outputLabel>
                            </f:facet>

                            <h:panelGrid columns="8" >
                                <p:outputLabel value="Pack" ></p:outputLabel>
                                <p:outputLabel value="Qty in Packs" ></p:outputLabel>
                                <p:outputLabel value="Free Qty in Packs" ></p:outputLabel>
                                <p:outputLabel value="Wholesale Rate" ></p:outputLabel>
                                <p:outputLabel value="Dis%" ></p:outputLabel>
                                <p:outputLabel value="Value" ></p:outputLabel>
                                <p:outputLabel value="Retail Rate" ></p:outputLabel>
                                <h:panelGroup >
                                    <p:focus id="focusQty" for="txtQty" ></p:focus>
                                    <p:focus id="focusItem" for="acStock" ></p:focus>
                                </h:panelGroup>


                                <p:commandButton  accesskey="a" id="btnAdd" value="Add" 
                                                  action="#{pharmacyWholesaleController.addBillItem}" 
                                                  process="@this acStock txtQty txtFreeQty txtRate :#{p:component('cmbPs')}" 
                                                  update=" :#{p:component('panelErrorMessage')}   :#{p:component('netTotal')} :#{p:component('pBillDetails')} :#{p:component('tblBillItem')} txtRate txtQty acStock focusItem " ></p:commandButton>
                            </h:panelGrid>

                            <table style="min-width: 300px;">
                                <tr style="vertical-align: top;">
                                    <td>
                                        <table style="width: 99%;" >


                                            <tr style="vertical-align: top;">
                                                <td colspan="4"  style="margin: auto; ">

                                                    <style>
                                                        .ui-autocomplete-input {width:350px!important;display: block;}
                                                        .ui-autocomplete{display: block!important;}
                                                    </style>
                                                    <p:autoComplete value="#{pharmacyWholesaleController.ampp}" completeMethod="#{amppController.completeAmpp}"
                                                                    var="ampp" itemLabel="#{ampp.name}" itemValue="#{ampp}"
                                                                    id="acPacks">
                                                        <p:ajax event="focus" process="acPacks"  ></p:ajax>
                                                        <p:ajax event="itemSelect"  process="acPacks" listener="#{pharmacyWholesaleController.handlePackSelect}"  update="acStock txtQty txtFreeQty txtRate focusQty " ></p:ajax>
                                                    </p:autoComplete>

                                                    <p:selectOneMenu  id="acStock" 
                                                                      value="#{pharmacyWholesaleController.stock}" 
                                                                      >
                                                        <f:selectItem itemLabel="No Stocks" ></f:selectItem>
                                                        <f:selectItems value="#{pharmacyWholesaleController.packStocks}" var="i" itemLabel="#{i.itemBatch.item.name}" itemValue="#{i}" ></f:selectItems>
                                                        <p:column headerText="Item">
                                                            <h:outputLabel value="#{i.itemBatch.item.name}"  style="width: 300px!important;"></h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Code">
                                                            <h:outputLabel value="#{i.itemBatch.item.code}" style="width: 50px!important;"></h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Generic">
                                                            <h:outputLabel value="#{i.itemBatch.item.vmp.name}" style="width: 150px!important;"></h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Retail Rate">
                                                            <h:outputLabel value="#{i.itemBatch.retailsaleRate}"  style="width: 50px!important;">
                                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                            </h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Wholesale Margin">
                                                            <h:outputLabel value="#{i.itemBatch.wholeSaleMargin}"  style="width: 50px!important;">
                                                            </h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Wholesale Rate">
                                                            <h:outputLabel value="#{i.itemBatch.wholesaleRate}"  style="width: 50px!important;">
                                                                <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                                            </h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Free For">
                                                            <h:outputLabel value="#{i.itemBatch.wholesaleFreeFor}"  style="width: 50px!important;">
                                                            </h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Free Qty">
                                                            <h:outputLabel value="#{i.itemBatch.wholesaleFreeQty}"  style="width: 50px!important;">
                                                            </h:outputLabel>
                                                        </p:column>

                                                        <p:column headerText="Stocks">
                                                            <h:outputLabel value="#{i.stock}"  style="width: 50px!important;">
                                                                <f:convertNumber pattern="#,###" ></f:convertNumber>
                                                            </h:outputLabel>
                                                        </p:column>
                                                        <p:column headerText="Expiary">
                                                            <h:outputLabel value="#{i.itemBatch.dateOfExpire}"  
                                                                           style="width: 100px!important;#{commonController.currentDateTime > i.itemBatch.dateOfExpire ?'color: red; background-color: yellow;':''}">
                                                                <f:convertDateTime pattern="dd/MM/yyyy" ></f:convertDateTime>
                                                            </h:outputLabel>
                                                        </p:column>
                                                        <p:ajax event="focus" process="acStock :#{p:component('cmbPs')}"  ></p:ajax>
                                                        <p:ajax event="change"   listener="#{pharmacyWholesaleController.handleSelect}"  update="txtQty txtFreeQty txtRate focusQty " ></p:ajax>
                                                    </p:selectOneMenu>
                                                </td>
                                                <td style="min-width: 50px;">
                                                    <p:inputText  accesskey="q"  autocomplete="off" id="txtQty" value="#{pharmacyWholesaleController.qty}" style="width: 50px!important;"   >
                                                        <p:ajax event="keyup"  listener="#{pharmacyWholesaleController.calculateBillItemListner}" process="acStock txtQty :#{p:component('cmbPs')}" update="txtRate txtVal" ></p:ajax>
                                                        <p:ajax event="blur"  listener="#{pharmacyWholesaleController.calculateBillItemListner}" process="acStock txtQty :#{p:component('cmbPs')}" update="txtRate txtVal" ></p:ajax>
                                                    </p:inputText>
                                                </td>
                                                <td style="min-width: 50px;">
                                                    <p:inputText  accesskey="f"  autocomplete="off" id="txtFreeQty" value="#{pharmacyWholesaleController.freeQty}" style="width: 50px!important;"   >
                                                        <p:ajax event="keyup"  listener="#{pharmacyWholesaleController.calculateBillItemListner}" process="acStock txtFreeQty :#{p:component('cmbPs')}" update="txtRate txtVal" ></p:ajax>
                                                        <p:ajax event="blur"  listener="#{pharmacyWholesaleController.calculateBillItemListner}" process="acStock txtFreeQty :#{p:component('cmbPs')}" update="txtRate txtVal" ></p:ajax>
                                                    </p:inputText>
                                                </td>
                                                <td style="padding: 2px;margin: auto; min-width: 50px; text-align: right; font-weight: bolder;">
                                                    <p:inputText id="txtRate" value="#{pharmacyWholesaleController.billItem.rate}" >
                                                        <f:convertNumber pattern="#,##0.00" />
                                                        <p:ajax event="keyup"  listener="#{pharmacyWholesaleController.calculateBillItemListner}" process="txtRate acStock txtFreeQty :#{p:component('cmbPs')}" update="txtVal" ></p:ajax>
                                                        <p:ajax event="blur"  listener="#{pharmacyWholesaleController.calculateBillItemListner}" process="txtRate acStock txtFreeQty :#{p:component('cmbPs')}" update="txtVal" ></p:ajax>
                                                    </p:inputText>
                                                </td>
                                                <td  style="padding: 2px;margin: auto; min-width: 50px; text-align: right; font-weight: bolder;">
                                                    <p:outputLabel id="txtVal" value="#{pharmacyWholesaleController.billItem.discount}" >
                                                        <f:convertNumber pattern="#,##0.00" />
                                                    </p:outputLabel>
                                                </td>
                                                <td>

                                                </td>



                                            </tr>
                                        </table>
                                    </td>
                                </tr>

                            </table>


                        </p:panel>
                        <p:panel >
                            <f:facet name="header" >
                                <p:outputLabel value="Bill Items" ></p:outputLabel>
                                <h:panelGroup id="panelBillTotals" style="float: right;" >
                                    <p:outputLabel value="Bill Total" ></p:outputLabel>
                                    <p:spacer height="1" width="20" ></p:spacer>
                                    <h:outputLabel id="netTotal" value="#{pharmacyWholesaleController.preBill.netTotal}" >
                                        <f:convertNumber pattern="#,##0.00" />
                                    </h:outputLabel>
                                </h:panelGroup>
                            </f:facet>

                            <h:panelGroup id="pBis">
                                <p:dataTable id="tblBillItem" 
                                             value="#{pharmacyWholesaleController.preBill.billItems}"
                                             var="bi" rowIndexVar="s" 
                                             editable="true" sortBy="#{bi.searialNo}" 
                                             emptyMessage="No Bill Items Added Yet !">
                                    <p:ajax event="rowEdit" listener="#{pharmacyWholesaleController.onEdit}" update="@this gros :#{p:component('pBillDetails')}   :#{p:component('netTotal')} :#{p:component('pBillDetails')} :#{p:component('tblBillItem')} " />  
                                    <p:ajax event="rowEditCancel" listener="#{pharmacyWholesaleController.onEdit}" update="@this gros   :#{p:component('netTotal')} :#{p:component('pBillDetails')} :#{p:component('tblBillItem')} " /> 
                                    <f:facet name="header">
                                        Added Bill Items
                                    </f:facet>

                                    <p:column>
                                        <f:facet name="header" >
                                            <div style="min-width: 200px;" ></div>
                                            <h:outputLabel value="Code" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <h:outputLabel style="min-width: 150px; text-wrap: avoid;" value="#{bi.pharmaceuticalBillItem.itemBatch.item.code}" ></h:outputLabel>
                                    </p:column>
                                    <p:column>
                                        <f:facet name="header" >
                                            <div style="min-width: 200px;" ></div>
                                            <h:outputLabel value="Item" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <h:outputLabel style="min-width: 150px; text-wrap: avoid;" value="#{bi.pharmaceuticalBillItem.itemBatch.item.name}" ></h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Qty">
                                        <f:facet name="header" >
                                            <div style="min-width: 50px;" ></div>
                                            <h:outputLabel value="Qty" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <p:cellEditor>  
                                            <f:facet name="output">  
                                                <h:outputText value="#{bi.qty}" >
                                                    <f:convertNumber integerOnly="true" />
                                                </h:outputText>
                                            </f:facet>  
                                            <f:facet name="input">  
                                                <p:inputText id="ipTblQty" value="#{bi.qty}" style="width:96%"/>  
                                            </f:facet>  
                                        </p:cellEditor> 
                                    </p:column>
                                    <p:column headerText="Price">
                                        <f:facet name="header" >
                                            <div style="min-width: 50px;" ></div>
                                            <h:outputLabel value="Rate" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <p:cellEditor>  
                                            <f:facet name="output">  
                                                <h:outputText value="#{bi.netRate}" >
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </f:facet>  
                                            <f:facet name="input">  
                                                <h:outputText value="#{bi.netRate}" >
                                                    <f:convertNumber pattern="#,##0.00" />
                                                </h:outputText>
                                            </f:facet>  
                                        </p:cellEditor> 
                                    </p:column>
                                    <p:column headerText="Free">
                                        <f:facet name="header" >
                                            <div style="min-width: 50px;" ></div>
                                            <h:outputLabel value="Free" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <p:cellEditor>  
                                            <f:facet name="output">  
                                                <h:outputText value="#{bi.pharmaceuticalBillItem.freeQtyInUnit}" >
                                                </h:outputText>
                                            </f:facet>  
                                            <f:facet name="input">  
                                                <p:inputText id="ipTblQtyFree" value="#{bi.pharmaceuticalBillItem.freeQtyInUnit}" style="width:96%"/>  
                                            </f:facet>  
                                        </p:cellEditor> 
                                    </p:column>
                                    <p:column >
                                        <f:facet name="header" >
                                            <div style="min-width: 50px;" ></div>
                                            <h:outputLabel value="Discount%" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        #{bi.pharmaceuticalBillItem.stock.itemBatch.retailsaleRate}
                                        <h:outputLabel id="rate" value="#{bi.pharmaceuticalBillItem.wholeSaleMargin}" >
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Val">
                                        <f:facet name="header" >
                                            <div style="min-width: 50px;" ></div>
                                            <h:outputLabel value="Value" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <h:outputLabel value="#{bi.netValue}" id="gros">
                                            <f:convertNumber pattern="#,##0.00" />
                                        </h:outputLabel>
                                    </p:column>
                                    <p:column headerText="Exp">
                                        <f:facet name="header" >
                                            <div style="min-width: 80px;" ></div>
                                            <h:outputLabel value="Expiary" style="min-width: 300px;" ></h:outputLabel>
                                        </f:facet>
                                        <h:outputLabel value="#{bi.pharmaceuticalBillItem.itemBatch.dateOfExpire}" style="#{commonController.currentDateTime > bi.pharmaceuticalBillItem.itemBatch.dateOfExpire ?'color: red; background-color: yellow;':''}" >
                                            <f:convertDateTime pattern="dd/MMM/yyyy" ></f:convertDateTime>
                                        </h:outputLabel>
                                    </p:column>

                                    <p:column headerText="Edit">
                                        <p:rowEditor ></p:rowEditor>
                                    </p:column>
                                    <p:column headerText="Remove">
                                        <p:commandLink  action="#{pharmacyWholesaleController.removeBillItem(bi)}" ajax="false" >
                                            <p:graphicImage library="image" name="remove.png" style="width:30px;height: 30px;" ></p:graphicImage>
                                        </p:commandLink>
                                    </p:column>
                                </p:dataTable>

                            </h:panelGroup>

                        </p:panel>




                    </p:panel>

                </h:form>



                <h:form>
                    <p:panel  rendered="#{pharmacyWholesaleController.billPreview}" >
                        <p:commandButton id="nullButton3" value="No Action" action="#" style="display: none;" ></p:commandButton>
                        <p:defaultCommand  target="btnPrint" />  

                        <div class="nonPrintBlock" >
                            <p:commandButton accesskey="p" id="btnPrint" value="Print" ajax="false" action="#{pharmacyWholesaleController.newSaleBill()}" actionListener="#{pharmacyWholesaleController.newSaleBill()}" >
                                <p:printer target="gpBillPreview" ></p:printer>
                            </p:commandButton>
                            <p:commandButton accesskey="n" value="New Pharmacy Bill"  ajax="false" action="#{pharmacyWholesaleController.newSaleBill()}" ></p:commandButton>


                            <p:remoteCommand name="rc" update="@all"  actionListener="#{pharmacyWholesaleController.newSaleBill()}" />

                            <p:commandButton value="Imprimir" type="button" 
                                             icon="ui-icon-print" oncomplete="rc();alert('AA');" ajax="false"
                                             style="display:block;margin-bottom: 20px">
                                <p:printer target="gpBillPreview" />
                            </p:commandButton>

                        </div>
                        <div >
                            <h:panelGroup   id="gpBillPreview"   > 
                                <phi:wholesaleBill bill="#{pharmacyWholesaleController.printBill}"></phi:wholesaleBill>
                            </h:panelGroup>
                        </div>



                    </p:panel>

                </h:form>

            </ui:define>

        </ui:composition>

    </body>
</html>
